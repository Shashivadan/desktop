'use strict';

var http = require('node:http');
var toURL = require('../unstable-core-do-not-import/http/toURL.js');
require('../unstable-core-do-not-import/rootConfig.js');
var nodeHTTPRequestHandler = require('./node-http/nodeHTTPRequestHandler.js');

/**
 * @internal
 */ function createHTTPHandler(opts) {
    return (req, res)=>{
        let path = '';
        try {
            const url = toURL.toURL(req.url);
            // get procedure path and remove the leading slash
            // /procedure -> procedure
            path = url.pathname.slice(1);
            nodeHTTPRequestHandler.nodeHTTPRequestHandler({
                ...opts,
                req,
                res,
                path
            });
        } catch (cause) {
            nodeHTTPRequestHandler.internal_exceptionHandler({
                req,
                res,
                path,
                ...opts
            })(cause);
        }
    };
}
function createHTTPServer(opts) {
    return http.createServer(createHTTPHandler(opts));
}

exports.createHTTPHandler = createHTTPHandler;
exports.createHTTPServer = createHTTPServer;
