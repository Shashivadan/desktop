'use strict';

var utils = require('../unstable-core-do-not-import/utils.js');
var TRPCError = require('../unstable-core-do-not-import/error/TRPCError.js');
require('../unstable-core-do-not-import/rootConfig.js');
var nodeHTTPRequestHandler = require('./node-http/nodeHTTPRequestHandler.js');

/**
 * If you're making an adapter for tRPC and looking at this file for reference, you should import types and functions from `@trpc/server` and `@trpc/server/http`
 *
 * @example
 * ```ts
 * import type { AnyTRPCRouter } from '@trpc/server'
 * import type { HTTPBaseHandlerOptions } from '@trpc/server/http'
 * ```
 */ // @trpc/server
function createNextApiHandler(opts) {
    let path = '';
    const handler = (req, res)=>{
        try {
            path = utils.run(()=>{
                if (typeof req.query['trpc'] === 'string') {
                    return req.query['trpc'];
                }
                if (Array.isArray(req.query['trpc'])) {
                    return req.query['trpc'].join('/');
                }
                throw new TRPCError.TRPCError({
                    message: 'Query "trpc" not found - is the file named `[trpc]`.ts or `[...trpc].ts`?',
                    code: 'INTERNAL_SERVER_ERROR'
                });
            });
            nodeHTTPRequestHandler.nodeHTTPRequestHandler({
                ...opts,
                req,
                res,
                path
            });
        } catch (cause) {
            nodeHTTPRequestHandler.internal_exceptionHandler({
                req,
                res,
                path,
                ...opts
            })(cause);
        }
    };
    return handler;
}

exports.createNextApiHandler = createNextApiHandler;
