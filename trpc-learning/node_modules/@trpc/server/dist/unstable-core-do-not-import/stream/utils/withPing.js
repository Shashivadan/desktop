'use strict';

var promiseTimer = require('./promiseTimer.js');

const PING_SYM = Symbol('ping');
const PING_RESULT = {
    value: PING_SYM,
    done: false
};
/**
 * Derives a new {@link AsyncGenerator} based of {@link iterable}, that yields {@link PING_SYM}
 * whenever no value has been yielded for {@link pingIntervalMs}.
 */ async function* withPing(iterable, pingIntervalMs) {
    const timer = promiseTimer.createPromiseTimer(pingIntervalMs);
    const iterator = iterable[Symbol.asyncIterator]();
    while(true){
        const nextPromise = iterator.next();
        const pingPromise = timer.start().promise.then(()=>PING_RESULT);
        let result;
        try {
            result = await Promise.race([
                nextPromise,
                pingPromise
            ]);
        } finally{
            timer.clear();
        }
        if (result.done) {
            return result.value;
        }
        yield result.value;
        timer.reset();
    }
}

exports.PING_SYM = PING_SYM;
exports.withPing = withPing;
